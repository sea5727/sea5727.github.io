---
layout: archive
title: "janus 시작하기 #2"
date: 2021-04-27 02:32:12 +0900
categories: janus
tag:
- janus
blog: true
author: ysh
description: 
sidebar:
  nav: "posts_navi"
---

## run janus
janus에서 제공하는 demo를 실행해보고 어떤 기능들이 있는지 파악해보겠습니다.
http server와 janus를 실행해둔상태로 진행하여야 합니다.
설치법과 기본 실행방법은 [start janus](2021-04-26-janus_start.md) 페이지를 참고하세요.

## echo test
*demos > Echo Test > Start* 를 선택합니다.
`chrome` 개발자 도구에서 *WebRTC error: getUserMedia not available* 라는 오류가 발생하네요.
`WebRTC`는 `https`가 기본인듯 합니다 ( `chrome`만 그런지는 모르겠습니다. 프론트 개발자가 아니어서요. )

### create certificate 
https를 위한 인증서를 생성해줍니다.
[HTTPS 관련 내용 보기]()
```
openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem
mkdir -p /opt/cert
mv key.pem /opt/cert
mv cert.pem /opt/cert
```

### edit config
https를 janus 설정에 추가해주어야 합니다.

#### janus folder architecture 

- bin : janus binary 폴더
- etc : config 폴더
- include : plugin include 폴더 (?)
- lib : plugin library 폴더 (?)
- share : script, javascript, demos 같은 유틸 폴더 (?)

#### janus configuration
`<janus-home>/etc/janus/` 폴더에는 여러 설정 파일의 sample들이 있습니다. 사용할 설정 파일은 이름에서 sample을 지우고 사용하면 됩니다.

`janus.jcfg`와 `janus.transport.http.jcfg` 설정 파일은 필수인듯 보입니다.

- janus.jcfg : 일반 설정. 설정 파일이나 플러그인 위치를 명시하거나 로그 포맷, binary 기동 규칙(background or foreground), 로그레벨 등을 설정
- janus.transport.http.jcfg.sample : 웹 서버 관련. `web-front` 가 접속할 포트, ssl포트, BASE-URL등을 설정. 
- janus.transport.pfunix.jcfg.sample : `Unix Socket` 을 사용할 수 있도록 하는 설정. unix socket path나 활성화 유무등을 설정.
- janus.transport.websocket.jcfg : `websocket` 관련 설정. (어떤것을 할 수 있는 설정일까?)
- janus.plugin.<demo-name>.jcfg : 각종 데모관련 설정 파일 ( 추측 )

#### janus.transport.http.jcfg.sample
generl.https, secore_port, certificates.cert_pem, cert_key 설정 파라미터들을 아래와 같이 변경하였습니다.

``` conf
general: {
        json = "indented"
        base_path = "/janus"
        http = true
        port = 8088
        https = true
        secure_port = 8089
}

admin: {
        admin_base_path = "/admin"
        admin_http = false
        admin_port = 7088
        admin_https = false
}

cors: {
}

certificates: {
        cert_pem = "/opt/cert/cert.pem"
        cert_key = "/opt/cert/key.pem"
}

```

### rerun janus
janus를 재기동해줍니다.
```
cd /opt/janus
./bin/janus -b
```

### start https server
http 서버는 `python3 -m http.server` 로 실행하였습니다.
https는 간단하게 파이썬 스크립트를 작성하여 동작시키도록 하겠습니다.
``` python
import http.server, ssl

server_address = ('0.0.0.0', 443)
httpd = http.server.HTTPServer(server_address, http.server.SimpleHTTPRequestHandler)
httpd.socket = ssl.wrap_socket(httpd.socket,
                               server_side=True,
                               certfile='/opt/cert/https-cert.pem', keyfile='/opt/cert/https-key.pem',
                               ssl_version=ssl.PROTOCOL_TLS)
httpd.serve_forever()
```

https 서버를 실행합니다.
```
cd /opt/janus/share/janus/demos
python3 <https-server-path>
```

## echo test
`web browser` 에서 `https://<URL>` 로 접속을 합니다. 그리고 demos > echo test > start 를 실행하면 아래화면을 보실 수 있습니다.

<img src="../_assets/_images/2021-04-27-janus_run_image1" alt="drawing" width="480" height="320"/>

## streaming

janus 데모 스트리밍을 실행해봅니다.
데모는 3가지 기능이 들어있습니다.
1. live streaming 
- 스트리머가 방송을 하는 케이스에 해당되는것으로 보이네요. janus 서버에서 수신하는 rtp를 replay해주는 기능입니다. rtp의 실시간 특성으로 방송처럼 중간부터 합류하여 스트리밍 됩니다.
2. file broadcast streaming
- 파일을 읽어 방송합니다. 방송의 특성상 중간부터 합류하여 스트리밍됩니다.
3. file on demand streaming 
- VOD 서비스입니다. START 시 파일을 처음부터 스트리밍합니다.


#### janus.plugin.streaming.jcfg
```
cp janus.plugin.streaming.jcfg.sample janus.plugin.streaming.jcfg
```

2,3 번기능은 환경설정의 `description`와 `filename` 파라미터들의 위치만 맞추면 될것으로 보입니다.
1번 기능은 rtp를 janus로 보내주면 `web browser` 에서 시청 할 수 있습니다.
janus를 실행하고 `web browser`에서 `Demos > Streaming` 에 접속합니다.
#### 1. live streaming (rtp relay)
gstreamer로 rtp를 janus 서버에 전송해보겠습니다. 설정파일을 보니 음성코덱은 opus에 pt=111, 영상코덱은 vp8에 pt=112 등 코덱별 설정값들을 확인할수있습니다
```
gst-launch-1.0 audiotestsrc ! audioconvert ! opusenc ! rtpopuspay pt=111 ! udpsink port=5002 host=127.0.0.1 videotestsrc ! videoconvert ! vp8enc ! rtpvp8pay pt=100 ! udpsink port=5004
```
<사진>
ffmpeg로 rtp를 janus 서버에 전송해보겠습니다.
```
ffmpeg는 터미널을 두개 열어서 실행합니다. ( 한 커맨드에서 입력하는 방법은 모르겠네요. )
ffmpeg -f lavfi -re -i aevalsrc="sin(400*2*PI*t)" -ar 8000 -c:a libopus -b:a 48000 -f rtp -payload_type 111 rtp://127.0.0.1:5002; 
ffmpeg -f lavfi -re -i testsrc=size=640x360:rate=30 -c:v vp8 -f rtp -payload_type 112 rtp://127.0.0.1:5004;
```
<사진>

### 2. file broadcast streaming 
방송 음성을 확인 할 수 있습니다.
### 3. file on demand streaming ( like VOD )
VOD 음성을 확인 할 수 있습니다.


## Video Call
```
cd /opt/janus/etc/janus
cp janus.plugin.videocall.jcfg.sample janus.plugin.videocall.jcfg
```
1:1 영상 통화를 하는 기능입니다. (stun같은 설정을 해주지 않았기때문에 통화기능은 내부 사설망에서 테스트 하겠습니다)
`Web browser`에서 `Demos > Video Call` 선택후 닉네임을 작성후 `Register`를 눌러줍니다.
안드로이드 크롬에서 `janus` 에 접속후 똑같이 `Demos > Video Call` 선택후 닉네임을 작성후 `Register`를 눌러줍니다.
반대편 단말 닉네임을 작성후 `Call`을 선택하면 1:1 영상통화를 할 수 있습니다.

TODO : <사진>



